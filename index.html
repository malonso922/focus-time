<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <title>Focus Timer • Countdown + Progress + Tasks</title>
  <style>
    :root{
      --bg:#111111; --panel:#161616;
      --accent:#4da3ff; --accent-2:#49d47a;
      --bar-start:#2e7ddd; --bar-end:#5aa8ff; /* progress gradient (dark -> light) */
      --focus:#a970ff; --text:#eef3ff; --muted:#a7b2cc; --danger:#ff5a5a;
      --radius:16px;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:14px/1.4 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      display:grid; place-items:center; padding:16px;
    }
    .card{
      width:min(680px,100%); background:var(--panel);
      border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.4);
      padding:12px 16px 18px;
    }

    /* --- Top bar actions (RIGHT aligned now) --- */
    .topbar{
      display:flex; align-items:center; gap:8px; margin-bottom:8px; justify-content:flex-end;
    }
    .iconbtn{
      width:36px; height:36px; display:grid; place-items:center; border-radius:999px;
      border:none; background:transparent; cursor:pointer; color:#e8f0ff;
    }
    .iconbtn:hover{ color:var(--accent); }
    .iconbtn svg{ width:22px; height:22px; display:block }
    .iconbtn .ring{ fill:none; stroke:currentColor; stroke-width:2 }
    .iconbtn .shape{ fill:currentColor }

    /* Task name + Duration inline and tight */
    .grid-inline{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; margin-bottom:6px; }
    .field{ min-width:220px; flex:1 1 auto }
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:4px}
    input,select{
      border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0f0f0f; color:#eef3ff; padding:10px 12px; outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    input:focus,select:focus{ border-color:var(--focus); box-shadow:0 0 0 2px color-mix(in srgb, var(--focus) 35%, transparent); }
    #durationField .row{display:flex; gap:8px; align-items:center}

    /* Left-aligned banner while running */
    .banner{margin:0 0 6px; font-size:16px; font-weight:800; text-align:left; color:#e6eeff}

    /* progress + dynamic clock on right */
    .bar{height:14px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:999px; overflow:hidden}
    .fill{ height:100%; width:0%; background: linear-gradient(90deg,var(--bar-start),var(--bar-end)); transition:width .3s ease, background .3s ease, opacity .25s ease; }
    .barRow{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; }
    .clockRight{ text-align:right; font-size:28px; font-weight:700; letter-spacing:.5px; font-variant-numeric: tabular-nums; }
    .meta{display:flex; justify-content:space-between; color:var(--muted); font-size:12px; margin-top:6px}

    /* ---------- Tasks ---------- */
    .tasks{ margin-top:12px; border-top:1px dashed rgba(255,255,255,.07); padding-top:12px; }
    .tasksHeader{ display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none; color:#dbe6ff; font-weight:800; letter-spacing:.2px; }
    .tasksHeader svg{ width:16px; height:16px; transform:rotate(0deg); transition:transform .2s ease }
    .tasksHeader.collapsed svg{ transform:rotate(-90deg) }
    .tasksHeader .count{ color:var(--muted); font-weight:600; margin-left:auto }
    .list{ margin-top:6px; display:grid; gap:6px }
    .item{
      display:grid; grid-template-columns:auto 1fr auto auto; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid rgba(255,255,255,.08); border-radius:12px; background:#121212;
    }
    .check{
      width:18px; height:18px; border-radius:50%; border:2px solid rgba(255,255,255,.35);
      display:grid; place-items:center; cursor:pointer; transition:border-color .15s ease, background .15s ease;
    }
    .check.done{ background:var(--accent-2); border-color:var(--accent-2) }
    .title{ font-weight:600; color:#e9f2ff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .title.done{ text-decoration:line-through; color:#8fa0bf }
    .est{
      border:1px solid rgba(255,255,255,.15); padding:4px 10px; border-radius:999px; cursor:pointer; background:#0f0f0f; min-width:48px; text-align:center;
      font-weight:700; color:#d9e8ff;
    }
    .est[contenteditable="true"]{ outline:none; border-color:var(--focus); box-shadow:0 0 0 2px color-mix(in srgb, var(--focus) 35%, transparent) }

    /* Trash can (hidden until hover) */
    .trash{ display:grid; place-items:center; width:30px; height:30px; color:transparent; cursor:pointer; border:none; background:transparent; }
    .item:hover .trash{ color:var(--danger); }
    .trash svg{ width:18px; height:18px; }

    /* Add row at bottom */
    .addRow{ display:grid; grid-template-columns: 1fr auto auto; gap:8px; margin-top:10px; align-items:center }
    .addRow input[name="taskTitle"]{ width:100% }
    .addRow input[name="taskEst"]{ width:110px; text-align:center }
    #addBtn{ background:transparent; border:none; color:#fff; cursor:pointer; font-size:22px; line-height:1; width:36px; height:36px; display:grid; place-items:center; }
    #addBtn:hover{ color:var(--accent); }

    /* Tips collapsible (below add row) */
    .tips{ margin-top:8px; }
    .tipsHeader{ display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none; color:var(--muted); font-size:12px; font-weight:600; }
    .tipsHeader svg{ width:12px; height:12px; transform:rotate(0deg); transition:transform .2s ease }
    .tipsHeader.collapsed svg{ transform:rotate(-90deg) }
    .tipsBody{ color:var(--muted); font-size:12px; margin-top:6px; display:block }
    .tipsBody .link{ color:#b9d4ff; text-decoration:none }
    .tipsBody .link:hover{ text-decoration:underline }

    .hidden{display:none!important}
  </style>
</head>
<body>
  <div class="card" id="app">

    <!-- Top-right controls -->
    <div class="topbar">
      <button class="iconbtn" id="toggleBtn" title="Start" aria-label="Start">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle class="ring" cx="12" cy="12" r="10" />
          <path class="shape" d="M10 8v8l6-4z"/>
        </svg>
      </button>
      <button class="iconbtn" id="resetBtn" title="Reset" aria-label="Reset" disabled>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle class="ring" cx="12" cy="12" r="10" />
          <rect class="shape" x="8.5" y="8.5" width="7" height="7" rx="1.2"/>
        </svg>
      </button>
    </div>

    <!-- Left-aligned banner on start -->
    <div class="banner hidden" id="banner"></div>

    <!-- Task + Duration inline -->
    <div class="grid-inline">
      <div class="field" id="taskField">
        <label>Task name</label>
        <input id="label" type="text" placeholder="e.g., Series 65 Study Sprint" />
      </div>
      <div class="field" id="durationField">
        <label>Duration</label>
        <div class="row">
          <input id="mins" type="number" min="1" step="1" value="25" style="width:110px"/>
          <select id="unit">
            <option value="min" selected>minutes</option>
            <option value="hr">hours</option>
          </select>
        </div>
      </div>
    </div>

    <!-- progress + clock on right -->
    <div style="margin-top:8px">
      <div class="barRow">
        <div class="bar" id="bar"><div class="fill" id="fill"></div></div>
        <div class="clockRight" id="clock">25:00</div>
      </div>
      <div class="meta">
        <div><span id="pct">0%</span> complete</div>
        <div>Elapsed: <span id="elapsed">0:00</span></div>
      </div>
    </div>

    <!-- Collapsible To-Do -->
    <div class="tasks" id="tasks">
      <div class="tasksHeader" id="tasksHeader" title="Toggle to-do list">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M8 10l4 4 4-4"/></svg>
        To-do
        <span class="count" id="tasksCount">0 open</span>
      </div>

      <div class="list" id="taskList"></div>

      <!-- Add row at bottom -->
      <div class="addRow" id="addRow">
        <input name="taskTitle" id="taskTitle" type="text" placeholder="Add a task…"/>
        <input name="taskEst" id="taskEst" type="text" placeholder="e.g., 25m or 2h" />
        <button id="addBtn" title="Add task" aria-label="Add task">+</button>
      </div>

      <!-- Tips (below add row) + Share preset -->
      <div class="tips">
        <div class="tipsHeader" id="tipsHeader" title="Toggle tips">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M8 10l4 4 4-4"/></svg>
          Tips & Links
        </div>
        <div class="tipsBody" id="tipsBody">
          Tip: click an estimate to set the timer •
          <a class="link" href="#" id="shareLink">Share preset</a>
        </div>
      </div>
    </div>
  </div>

  <audio id="ding" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCAAAACAAACbG1hAAAAAAAz//8AAP//AACQAAACcQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
  </audio>

<script>
(function(){
  const $ = id=>document.getElementById(id);
  const label=$('label'), mins=$('mins'), unit=$('unit');
  const clock=$('clock');
  const toggleBtn=$('toggleBtn'), resetBtn=$('resetBtn');
  const bar=$('bar'), fill=$('fill'), pct=$('pct'), elapsed=$('elapsed');
  const ding=$('ding');
  const shareLink=$('shareLink');
  const banner=$('banner');
  const taskField=$('taskField');
  const durationField=$('durationField');

  /* Tasks UI refs */
  const tasks=$('tasks'), tasksHeader=$('tasksHeader'), tasksCount=$('tasksCount');
  const addRow=$('addRow'), addBtn=$('addBtn'), taskTitle=$('taskTitle'), taskEst=$('taskEst');
  const taskList=$('taskList');
  const tipsHeader=$('tipsHeader'), tipsBody=$('tipsBody');

  let totalMs=0, startAt=0, elapsedMs=0, timer=null, running=false;

  const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
  function fmt(ms){
    ms=Math.max(0,Math.floor(ms/1000));
    const h=Math.floor(ms/3600), m=Math.floor((ms%3600)/60), s=ms%60;
    return h? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` : `${m}:${String(s).padStart(2,'0')}`;
  }
  function computeTotal(){
    const v=parseFloat(mins.value||0);
    totalMs = (unit.value==='hr'? v*60 : v) * 60*1000;
    totalMs = Math.max(1000,totalMs);
  }
  function updateShare(){
    const params=new URLSearchParams({label:label.value, mins:mins.value, unit:unit.value});
    shareLink.href = `${location.origin}${location.pathname}?${params.toString()}`;
  }
  function setGradient(p){
    if(p < 67){ fill.style.setProperty('--bar-start','#2e7ddd'); fill.style.setProperty('--bar-end','#5aa8ff'); }
    else      { fill.style.setProperty('--bar-start','#3dbd6d'); fill.style.setProperty('--bar-end','#6be28f'); }
  }
  function draw(){
    const done=Math.max(0,Math.min(elapsedMs,totalMs));
    const p = Math.round( (done/totalMs)*100 );
    setGradient(p);
    fill.style.width = p + '%';
    pct.textContent = p + '%';
    clock.textContent = fmt(totalMs - done);
    elapsed.textContent = fmt(done);
  }
  function setState(newRunning){
    running=newRunning;
    toggleBtn.title = running ? 'Pause' : 'Start';
    toggleBtn.setAttribute('aria-label', toggleBtn.title);
    resetBtn.disabled = !running && elapsedMs===0;
    toggleBtn.innerHTML = running
      ? `<svg viewBox="0 0 24 24" aria-hidden="true">
           <circle class="ring" cx="12" cy="12" r="10" />
           <rect class="shape" x="9" y="7" width="2.8" height="10" rx="0.8"/>
           <rect class="shape" x="12.8" y="7" width="2.8" height="10" rx="0.8"/>
         </svg>`
      : `<svg viewBox="0 0 24 24" aria-hidden="true">
           <circle class="ring" cx="12" cy="12" r="10" />
           <path class="shape" d="M10 8v8l6-4z"/>
         </svg>`;
  }
  function start(){
    computeTotal();
    if(elapsedMs>=totalMs){ elapsedMs=0; }
    if(!running){ startAt=Date.now()-elapsedMs; timer=requestAnimationFrame(tick); }
    setState(true);
    banner.textContent = label.value || 'Untitled Task';
    banner.classList.remove('hidden');
    taskField.classList.add('hidden');
    durationField.classList.add('hidden');
  }
  function pause(){
    if(running){ cancelAnimationFrame(timer); elapsedMs=Date.now()-startAt; setState(false); draw(); }
  }
  function reset(){
    cancelAnimationFrame(timer); elapsedMs=0; setState(false); draw();
    banner.classList.add('hidden');
    taskField.classList.remove('hidden');
    durationField.classList.remove('hidden');
  }
  function tick(){
    elapsedMs = Date.now()-startAt;
    if(elapsedMs>=totalMs){
      elapsedMs=totalMs; draw(); setState(false);
      try{ ding.currentTime=0; ding.play().catch(()=>{});}catch(e){}
      try{ if('Notification' in window && Notification.permission==='granted'){ new Notification('Timer done', { body: label.value || 'Focus timer complete' }); } }catch(e){}
      return;
    }
    draw(); timer=requestAnimationFrame(tick);
  }

  /* ---------- Tasks: data + persistence ---------- */
  let todos = []; // {id, title, estimate, done}
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function saveAll(){ const data={ timer:{label:label.value, mins:mins.value, unit:unit.value}, todos }; try{ localStorage.setItem('focus-timer-v2', JSON.stringify(data)); }catch(e){} }
  function loadAll(){
    try{
      const raw = localStorage.getItem('focus-timer-v2'); if(!raw) return;
      const data = JSON.parse(raw);
      if(data.timer){ if(data.timer.label!=null) label.value=data.timer.label; if(data.timer.mins!=null) mins.value=data.timer.mins; if(data.timer.unit!=null) unit.value=data.timer.unit; }
      if(Array.isArray(data.todos)) todos = data.todos;
    }catch(e){}
  }

  /* Estimate parsing */
  function parseEstimate(text){
    if(!text) return null;
    const s = String(text).trim().toLowerCase().replace(/\s+/g,''); if(!s) return null;
    let h=0, m=0; const m1 = s.match(/^(?:(\d+(?:\.\d+)?)h)?(?:(\d+)m)?$/);
    if(m1){ if(m1[1]) h = parseFloat(m1[1]); if(m1[2]) m = parseInt(m1[2],10)||0; const totalMin = Math.round(h*60 + m); return {mins: totalMin, unit:'min', pretty: prettyEstimate(totalMin)}; }
    if(/^\d+$/.test(s)){ const totalMin = parseInt(s,10); return {mins: totalMin, unit:'min', pretty: prettyEstimate(totalMin)}; }
    return null;
  }
  function prettyEstimate(totalMin){
    if(totalMin % 60 === 0){ return `${totalMin/60}h`; }
    if(totalMin > 60){ const hrs = Math.floor(totalMin/60); const mins = totalMin % 60; return `${hrs}h${mins}m`; }
    return `${totalMin}m`;
  }

  /* Tasks UI */
  function renderTasks(){
    taskList.innerHTML = '';
    let open = 0;
    todos.forEach(t => {
      if(!t.done) open++;
      const row = document.createElement('div'); row.className = 'item';

      const check = document.createElement('div');
      check.className = 'check' + (t.done ? ' done':'');
      check.title = t.done ? 'Mark as not done' : 'Mark as done';
      check.addEventListener('click', ()=>{ t.done = !t.done; saveAll(); renderTasks(); });
      const dot = document.createElement('div');
      dot.style.width='8px'; dot.style.height='8px'; dot.style.borderRadius='50%'; dot.style.background='currentColor'; dot.style.opacity='0.9';
      check.appendChild(dot);

      const title = document.createElement('div');
      title.className = 'title' + (t.done ? ' done' : '');
      title.textContent = t.title;
      title.title = 'Click to set as current task';
      title.addEventListener('click', ()=>{ label.value = t.title; saveAll(); });

      const est = document.createElement('span');
      est.className = 'est'; est.textContent = t.estimate || '';
      est.title = 'Click to set timer • Shift+Click to edit';
      est.addEventListener('click', (e)=>{
        if(e.shiftKey){
          est.setAttribute('contenteditable', 'true'); est.focus();
          const sel = window.getSelection(); const r = document.createRange();
          r.selectNodeContents(est); sel.removeAllRanges(); sel.addRange(r);
          return;
        }
        const parsed = parseEstimate(est.textContent); if(!parsed) return;
        mins.value = parsed.mins; unit.value = 'min';
        label.value = t.title || label.value;
        elapsedMs = 0; computeTotal(); draw(); updateShare(); saveAll();
      });
      est.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); est.blur(); } });
      est.addEventListener('blur', ()=>{
        if(est.getAttribute('contenteditable')!=='true') return;
        est.removeAttribute('contenteditable');
        const parsed = parseEstimate(est.textContent);
        est.textContent = parsed ? (t.estimate = parsed.pretty) : (t.estimate || '');
        saveAll();
      });

      const trash = document.createElement('button');
      trash.className = 'trash'; trash.title = 'Delete task';
      trash.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true">
        <path class="shape" fill="currentColor" d="M9 3h6l1 2h4v2h-1l-1 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 7H4V5h4l1-2zm1.5 6v9h2V9h-2z"/>
      </svg>`;
      trash.addEventListener('click', ()=>{ todos = todos.filter(x=>x!==t); saveAll(); renderTasks(); });

      row.appendChild(check); row.appendChild(title); row.appendChild(est); row.appendChild(trash);
      taskList.appendChild(row);
    });
    tasksCount.textContent = `${open} open`;
  }

  function addTask(){
    const title = taskTitle.value.trim();
    const estRaw = taskEst.value.trim();
    if(!title) return;
    let pretty = '';
    if(estRaw){ const parsed = parseEstimate(estRaw); if(parsed) pretty = parsed.pretty; }
    todos.unshift({ id: uid(), title, estimate: pretty, done:false });
    taskTitle.value=''; taskEst.value='';
    saveAll(); renderTasks();
  }

  /* Collapsibles */
  let collapsedTasks = false;
  function setCollapsedTasks(c){
    collapsedTasks = c;
    if(collapsedTasks){
      tasksHeader.classList.add('collapsed');
      taskList.style.display='none';
      addRow.style.display='none';
      tipsHeader.style.display='none';
      tipsBody.style.display='none';
    }else{
      tasksHeader.classList.remove('collapsed');
      taskList.style.display='';
      addRow.style.display='';
      tipsHeader.style.display='';
      tipsBody.style.display= collapsedTips ? 'none' : 'block';
    }
  }

  let collapsedTips = true; // tips collapsed by default
  function setCollapsedTips(c){
    collapsedTips = c;
    if(collapsedTips){ tipsHeader.classList.add('collapsed'); tipsBody.style.display='none'; }
    else{ tipsHeader.classList.remove('collapsed'); tipsBody.style.display='block'; }
  }

  /* Events */
  [label, mins, unit].forEach(el=>{
    el.addEventListener('input',()=>{ updateShare(); saveAll(); computeTotal(); draw(); });
    el.addEventListener('change',()=>{ updateShare(); saveAll(); computeTotal(); draw(); });
  });
  toggleBtn.addEventListener('click', ()=>{ running ? pause() : start(); saveAll(); });
  resetBtn.addEventListener('click', ()=>{ reset(); saveAll(); });

  document.addEventListener('keydown', (e)=>{
    if(e.key==='r' || e.key==='R'){ reset(); }
    if(e.key==='Enter' && (document.activeElement===taskTitle || document.activeElement===taskEst)){
      e.preventDefault(); addTask();
    }
  });

  addBtn.addEventListener('click', addTask);
  tasksHeader.addEventListener('click', ()=> setCollapsedTasks(!collapsedTasks));
  tipsHeader.addEventListener('click', ()=> setCollapsedTips(!collapsedTips));

  /* Init */
  (function init(){
    try{ if('Notification' in window && Notification.permission==='default'){ Notification.requestPermission().catch(()=>{}); } }catch(e){}
    loadAll();
    computeTotal(); draw(); updateShare();
    renderTasks();
    setCollapsedTasks(false);
    setCollapsedTips(true);
  })();
})();
</script>
</body>
</html>
