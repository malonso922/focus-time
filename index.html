<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <title>Focus Timer • Countdown + Progress + Tasks</title>
  <style>
    :root{
      --bg:#111111; --panel:#161616;
      --accent:#4da3ff; --accent-2:#49d47a;
      --bar-start:#2e7ddd; --bar-end:#5aa8ff; /* progress gradient (dark -> light) */
      --focus:#a970ff; --text:#eef3ff; --muted:#a7b2cc; --danger:#ff5a5a;
      --radius:16px;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:14px/1.4 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      display:grid; place-items:center; padding:16px;
    }
    .card{
      width:min(680px,100%); background:var(--panel);
      border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.4);
      padding:12px 16px 18px;
    }

    /* --- Top bar ----------------------------------------------------------- */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:8px;
    }

    /* Left side has two modes: pre-start form vs running banner */
    .leftTop{ min-width:0; flex:1 1 auto; }
    .hidden{ display:none !important; }

    /* Pre-start row (Task + Duration inline) */
    .preRow{
      display:flex; align-items:flex-end; gap:8px; min-width:0;
    }
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:4px}
    .field input, .field select{
      border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0f0f0f; color:#eef3ff; padding:10px 12px; outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .field input:focus, .field select:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 2px color-mix(in srgb, var(--focus) 35%, transparent);
    }
    .taskField{ flex:1 1 auto; min-width:200px }
    .durationField{ display:flex; gap:8px; align-items:center }
    .durationField input{ width:110px }

    /* Running row (banner + % next to it) */
    .runRow{
      position:relative; display:flex; align-items:center; gap:10px; min-width:0;
    }
    .banner{
      font-size:16px; font-weight:800; color:#e6eeff;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      padding-right:80px; /* reserve for % */
      flex:1 1 auto; min-width:0;
    }
    .pctTop{
      position:absolute; right:0; top:50%; transform:translateY(-50%);
      font-size:16px; font-weight:800; white-space:nowrap;
      color:#cfe0ff; transition: color .25s ease;
    }

    /* Right side actions */
    .actions{ display:flex; align-items:center; gap:8px }
    .iconbtn{
      width:36px; height:36px; display:grid; place-items:center; border-radius:999px;
      border:none; background:transparent; cursor:pointer; color:#e8f0ff;
    }
    .iconbtn:hover{ color:var(--accent); }
    .iconbtn svg{ width:22px; height:22px; display:block }
    .iconbtn .ring{ fill:none; stroke:currentColor; stroke-width:2 }
    .iconbtn .shape{ fill:currentColor }

    /* Progress + clock ------------------------------------------------------ */
    .bar{height:14px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:999px; overflow:hidden}
    .fill{ height:100%; width:0%; background: linear-gradient(90deg,var(--bar-start),var(--bar-end)); transition:width .3s ease, background .3s ease, opacity .25s ease; }
    .barRow{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; }
    .clockRight{ text-align:right; font-size:28px; font-weight:700; letter-spacing:.5px; font-variant-numeric: tabular-nums; }

    /* Tasks ----------------------------------------------------------------- */
    .tasks{ margin-top:12px; border-top:1px dashed rgba(255,255,255,.07); padding-top:12px; }
    .tasksHeader{ display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none; color:#dbe6ff; font-weight:800; letter-spacing:.2px; }
    .tasksHeader svg{ width:16px; height:16px; transform:rotate(0deg); transition:transform .2s ease }
    .tasksHeader.collapsed svg{ transform:rotate(-90deg) }
    .tasksHeader .count{ color:#9fb0cf; font-weight:600; margin-left:auto }
    .list{ margin-top:6px; display:grid; gap:6px }
    .item{
      display:grid; grid-template-columns:auto 1fr auto auto; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid rgba(255,255,255,.08); border-radius:12px; background:#121212;
    }
    .check{
      width:18px; height:18px; border-radius:50%; border:2px solid rgba(255,255,255,.35);
      display:grid; place-items:center; cursor:pointer; transition:border-color .15s ease, background .15s ease;
    }
    .check.done{ background:var(--accent-2); border-color:var(--accent-2) }
    .title{ font-weight:600; color:#e9f2ff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; cursor:pointer }
    .title.done{ text-decoration:line-through; color:#8fa0bf }
    .est{
      border:1px solid rgba(255,255,255,.15); padding:4px 10px; border-radius:999px; cursor:pointer; background:#0f0f0f; min-width:48px; text-align:center;
      font-weight:700; color:#d9e8ff;
    }
    .est[contenteditable="true"]{ outline:none; border-color:var(--focus); box-shadow:0 0 0 2px color-mix(in srgb, var(--focus) 35%, transparent) }
    .trash{ display:grid; place-items:center; width:30px; height:30px; color:transparent; cursor:pointer; border:none; background:transparent; }
    .item:hover .trash{ color:var(--danger); }
    .trash svg{ width:18px; height:18px; }

    /* Add row */
    .addRow{ display:grid; grid-template-columns: 1fr auto auto; gap:8px; margin-top:10px; align-items:center }
    .addRow input[name="taskTitle"]{ width:100% }
    .addRow input[name="taskEst"]{ width:110px; text-align:center }
    #addBtn{ background:transparent; border:none; color:#fff; cursor:pointer; font-size:22px; line-height:1; width:36px; height:36px; display:grid; place-items:center; }
    #addBtn:hover{ color:var(--accent); }

    /* Tips */
    .tips{ margin-top:8px; }
    .tipsHeader{ display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none; color:#a7b2cc; font-size:12px; font-weight:600; }
    .tipsHeader svg{ width:12px; height:12px; transform:rotate(0deg); transition:transform .2s ease }
    .tipsHeader.collapsed svg{ transform:rotate(-90deg) }
    .tipsBody{ color:#a7b2cc; font-size:12px; margin-top:6px; display:block }
    .tipsBody .link{ color:#b9d4ff; text-decoration:none }
    .tipsBody .link:hover{ text-decoration:underline }
  </style>
</head>
<body>
  <div class="card" id="app">

    <!-- Top bar: left switches between preRow and runRow; right is controls -->
    <div class="topbar">
      <div class="leftTop">
        <!-- Pre-start form row -->
        <div class="preRow" id="preRow">
          <div class="field taskField" id="taskField">
            <label>Task name</label>
            <input id="label" type="text" placeholder="e.g., Court Documentation" />
          </div>
          <div class="field" id="durationField">
            <label>Duration</label>
            <div class="durationField">
              <input id="mins" type="number" min="1" step="1" value="25"/>
              <select id="unit">
                <option value="min" selected>minutes</option>
                <option value="hr">hours</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Running row (shows after Start) -->
        <div class="runRow hidden" id="runRow">
          <div class="banner" id="banner" title=""></div>
          <div class="pctTop hidden" id="pctTop">0%</div>
        </div>
      </div>

      <div class="actions">
        <button class="iconbtn" id="toggleBtn" title="Start" aria-label="Start">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <circle class="ring" cx="12" cy="12" r="10" />
            <path class="shape" d="M10 8v8l6-4z"/>
          </svg>
        </button>
        <button class="iconbtn" id="resetBtn" title="Reset" aria-label="Reset" disabled>
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <circle class="ring" cx="12" cy="12" r="10" />
            <rect class="shape" x="8.5" y="8.5" width="7" height="7" rx="1.2"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- progress + clock on right -->
    <div>
      <div class="barRow">
        <div class="bar" id="bar"><div class="fill" id="fill"></div></div>
        <div class="clockRight" id="clock">25:00</div>
      </div>
    </div>

    <!-- To-do list -->
    <div class="tasks" id="tasks">
      <div class="tasksHeader" id="tasksHeader" title="Toggle to-do list">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M8 10l4 4 4-4"/></svg>
        To-do
        <span class="count" id="tasksCount">0 open</span>
      </div>

      <div class="list" id="taskList"></div>

      <div class="addRow" id="addRow">
        <input name="taskTitle" id="taskTitle" type="text" placeholder="Add a task…"/>
        <input name="taskEst" id="taskEst" type="text" placeholder="e.g., 25m or 2h" />
        <button id="addBtn" title="Add task" aria-label="Add task">+</button>
      </div>

      <div class="tips">
        <div class="tipsHeader" id="tipsHeader" title="Toggle tips">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M8 10l4 4 4-4"/></svg>
          Tips & Links
        </div>
        <div class="tipsBody" id="tipsBody">
          Tip: click an estimate to set the timer •
          <a class="link" href="#" id="shareLink">Share preset</a>
        </div>
      </div>
    </div>
  </div>

  <audio id="ding" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCAAAACAAACbG1hAAAAAAAz//8AAP//AACQAAACcQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
  </audio>

<script>
(function(){
  const $ = id=>document.getElementById(id);

  /* Topbar elements */
  const preRow = $('preRow');
  const runRow = $('runRow');
  const banner = $('banner');
  const pctTop = $('pctTop');

  /* Inputs / controls */
  const label=$('label'), mins=$('mins'), unit=$('unit');
  const toggleBtn=$('toggleBtn'), resetBtn=$('resetBtn');
  const clock=$('clock');
  const bar=$('bar'), fill=$('fill');
  const ding=$('ding');
  const shareLink=$('shareLink');

  /* Tasks */
  const tasksCount=$('tasksCount');
  const taskList=$('taskList');
  const addBtn=$('addBtn'), taskTitle=$('taskTitle'), taskEst=$('taskEst');
  const tasksHeader=$('tasksHeader'), tipsHeader=$('tipsHeader'), tipsBody=$('tipsBody');

  let totalMs=0, startAt=0, elapsedMs=0, timer=null, running=false;
  let todos=[];

  /* Helpers */
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
  function fmt(ms){
    ms=Math.max(0,Math.floor(ms/1000));
    const h=Math.floor(ms/3600), m=Math.floor((ms%3600)/60), s=ms%60;
    return h? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` : `${m}:${String(s).padStart(2,'0')}`;
  }
  function computeTotal(){
    const v=parseFloat(mins.value||0);
    totalMs = (unit.value==='hr'? v*60 : v) * 60*1000;
    totalMs = Math.max(1000,totalMs);
  }
  function updateShare(){
    if(!shareLink) return;
    const params=new URLSearchParams({label:label.value, mins:mins.value, unit:unit.value});
    shareLink.href = `${location.origin}${location.pathname}?${params.toString()}`;
  }
  function setGradientAndPct(p){
    if(p < 67){
      fill.style.setProperty('--bar-start','#2e7ddd');
      fill.style.setProperty('--bar-end','#5aa8ff');
      pctTop.style.color = '#cfe0ff';
    }else{
      fill.style.setProperty('--bar-start','#3dbd6d');
      fill.style.setProperty('--bar-end','#6be28f');
      pctTop.style.color = '#6be28f';
    }
  }
  function draw(){
    const done=clamp(elapsedMs,0,totalMs);
    const p = Math.round( (done/totalMs)*100 );
    setGradientAndPct(p);
    fill.style.width = p + '%';
    if(!pctTop.classList.contains('hidden')) pctTop.textContent = p + '%';
    clock.textContent = fmt(totalMs - done);
  }

  function setState(newRunning){
    running=newRunning;
    toggleBtn.title = running ? 'Pause' : 'Start';
    toggleBtn.setAttribute('aria-label', toggleBtn.title);
    resetBtn.disabled = !running && elapsedMs===0;
    toggleBtn.innerHTML = running
      ? `<svg viewBox="0 0 24 24" aria-hidden="true"><circle class="ring" cx="12" cy="12" r="10" /><rect class="shape" x="9" y="7" width="2.8" height="10" rx="0.8"/><rect class="shape" x="12.8" y="7" width="2.8" height="10" rx="0.8"/></svg>`
      : `<svg viewBox="0 0 24 24" aria-hidden="true"><circle class="ring" cx="12" cy="12" r="10" /><path class="shape" d="M10 8v8l6-4z"/></svg>`;
  }

  function showPreRow(){
    preRow.classList.remove('hidden');
    runRow.classList.add('hidden');
    pctTop.classList.add('hidden');   // % hidden pre-start
  }
  function showRunRow(){
    const taskText = label.value || 'Untitled Task';
    banner.textContent = taskText;
    banner.title = taskText;
    preRow.classList.add('hidden');
    runRow.classList.remove('hidden');
    pctTop.classList.remove('hidden'); // % visible only after start
  }

  function start(){
    computeTotal();
    if(elapsedMs>=totalMs){ elapsedMs=0; }
    if(!running){ startAt=Date.now()-elapsedMs; timer=requestAnimationFrame(tick); }
    setState(true);
    showRunRow();
  }
  function pause(){
    if(running){ cancelAnimationFrame(timer); elapsedMs=Date.now()-startAt; setState(false); draw(); }
  }
  function reset(){
    cancelAnimationFrame(timer); elapsedMs=0; setState(false); draw();
    // Back to pre-start layout
    showPreRow();
  }
  function tick(){
    elapsedMs = Date.now()-startAt;
    if(elapsedMs>=totalMs){
      elapsedMs=totalMs; draw(); setState(false);
      try{ ding.currentTime=0; ding.play().catch(()=>{});}catch(e){}
      try{ if('Notification' in window && Notification.permission==='granted'){ new Notification('Timer done', { body: label.value || 'Focus timer complete' }); } }catch(e){}
      return;
    }
    draw(); timer=requestAnimationFrame(tick);
  }

  /* Storage */
  function saveAll(){ try{ localStorage.setItem('focus-timer-v2', JSON.stringify({timer:{label:label.value, mins:mins.value, unit:unit.value}, todos})) }catch(e){} }
  function loadAll(){
    try{
      const raw = localStorage.getItem('focus-timer-v2'); if(!raw) return;
      const data = JSON.parse(raw);
      if(data.timer){ if(data.timer.label!=null) label.value=data.timer.label; if(data.timer.mins!=null) mins.value=data.timer.mins; if(data.timer.unit!=null) unit.value=data.timer.unit; }
      if(Array.isArray(data.todos)) todos = data.todos;
    }catch(e){}
  }

  /* Estimates */
  function parseEstimate(text){
    if(!text) return null;
    const s = String(text).trim().toLowerCase().replace(/\s+/g,''); if(!s) return null;
    let h=0, m=0; const m1 = s.match(/^(?:(\d+(?:\.\d+)?)h)?(?:(\d+)m)?$/);
    if(m1){ if(m1[1]) h = parseFloat(m1[1]); if(m1[2]) m = parseInt(m1[2],10)||0; const totalMin = Math.round(h*60 + m); return {mins: totalMin, pretty: prettyEstimate(totalMin)}; }
    if(/^\d+$/.test(s)){ const totalMin = parseInt(s,10); return {mins: totalMin, pretty: prettyEstimate(totalMin)}; }
    return null;
  }
  function prettyEstimate(totalMin){
    if(totalMin % 60 === 0){ return `${totalMin/60}h`; }
    if(totalMin > 60){ const hrs = Math.floor(totalMin/60); const mins = totalMin % 60; return `${hrs}h${mins}m`; }
    return `${totalMin}m`;
  }

  /* Tasks */
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function renderTasks(){
    taskList.innerHTML='';
    let open=0;
    todos.forEach(t=>{
      if(!t.done) open++;
      const row=document.createElement('div'); row.className='item';

      const check=document.createElement('div');
      check.className='check'+(t.done?' done':'');
      check.title=t.done?'Mark as not done':'Mark as done';
      check.addEventListener('click', ()=>{ t.done=!t.done; saveAll(); renderTasks(); });
      const dot=document.createElement('div');
      dot.style.width='8px'; dot.style.height='8px'; dot.style.borderRadius='50%'; dot.style.background='currentColor'; dot.style.opacity='0.9';
      check.appendChild(dot);

      const title=document.createElement('div');
      title.className='title'+(t.done?' done':'');
      title.textContent=t.title;
      title.title='Click to apply this task and estimate';
      title.addEventListener('click', ()=>{
        label.value=t.title;
        if(t.estimate){
          const parsed=parseEstimate(t.estimate);
          if(parsed){ mins.value=parsed.mins; unit.value='min'; }
        }
        elapsedMs=0; computeTotal(); draw(); updateShare(); saveAll();
      });

      const est=document.createElement('span');
      est.className='est'; est.textContent=t.estimate||'';
      est.title='Click to set timer • Shift+Click to edit';
      est.addEventListener('click', (e)=>{
        if(e.shiftKey){
          est.setAttribute('contenteditable','true'); est.focus();
          const sel=window.getSelection(); const r=document.createRange();
          r.selectNodeContents(est); sel.removeAllRanges(); sel.addRange(r);
          return;
        }
        const parsed=parseEstimate(est.textContent); if(!parsed) return;
        mins.value=parsed.mins; unit.value='min';
        label.value=t.title||label.value;
        elapsedMs=0; computeTotal(); draw(); updateShare(); saveAll();
      });
      est.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); est.blur(); } });
      est.addEventListener('blur', ()=>{
        if(est.getAttribute('contenteditable')!=='true') return;
        est.removeAttribute('contenteditable');
        const parsed=parseEstimate(est.textContent);
        est.textContent= parsed ? (t.estimate=parsed.pretty) : (t.estimate||'');
        saveAll();
      });

      const trash=document.createElement('button');
      trash.className='trash'; trash.title='Delete task';
      trash.innerHTML=`<svg viewBox="0 0 24 24" aria-hidden="true"><path class="shape" fill="currentColor" d="M9 3h6l1 2h4v2h-1l-1 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 7H4V5h4l1-2zm1.5 6v9h2V9h-2z"/></svg>`;
      trash.addEventListener('click', ()=>{ todos=todos.filter(x=>x!==t); saveAll(); renderTasks(); });

      row.appendChild(check); row.appendChild(title); row.appendChild(est); row.appendChild(trash);
      taskList.appendChild(row);
    });
    tasksCount.textContent=`${open} open`;
  }

  function addTask(){
    const title=taskTitle.value.trim();
    const estRaw=taskEst.value.trim();
    if(!title) return;
    let pretty='';
    if(estRaw){ const parsed=parseEstimate(estRaw); if(parsed) pretty=parsed.pretty; }
    // chronological order: push to end (first entered stays on top)
    todos.push({id:uid(), title, estimate:pretty, done:false});
    taskTitle.value=''; taskEst.value='';
    saveAll(); renderTasks();
    taskTitle.focus(); // keep typing next task
  }

  /* Events */
  [label, mins, unit].forEach(el=>{
    el.addEventListener('input', ()=>{ updateShare(); saveAll(); computeTotal(); draw(); });
    el.addEventListener('change',()=>{ updateShare(); saveAll(); computeTotal(); draw(); });
  });
  toggleBtn.addEventListener('click', ()=>{ running ? pause() : start(); saveAll(); });
  resetBtn.addEventListener('click', ()=>{ reset(); saveAll(); });

  document.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && (document.activeElement===taskTitle || document.activeElement===taskEst)){
      e.preventDefault(); addTask();
    }
    if(e.key==='r' || e.key==='R'){ reset(); }
  });
  addBtn.addEventListener('click', addTask);

  tasksHeader.addEventListener('click', ()=>{
    const c = document.body.dataset.tasksCollapsed === '1';
    document.body.dataset.tasksCollapsed = c ? '0' : '1';
    tasksHeader.classList.toggle('collapsed', !c);
    document.querySelector('.list').style.display = c ? '' : 'none';
    document.querySelector('.addRow').style.display = c ? '' : 'none';
    const tipsH = $('tipsHeader'), tipsB = $('tipsBody');
    tipsH.style.display = c ? '' : 'none';
    tipsB.style.display = c ? (document.body.dataset.tipsCollapsed==='1' ? 'none':'block') : 'none';
  });
  tipsHeader.addEventListener('click', ()=>{
    const t = document.body.dataset.tipsCollapsed === '1';
    document.body.dataset.tipsCollapsed = t ? '0' : '1';
    tipsHeader.classList.toggle('collapsed', !t);
    tipsBody.style.display = t ? 'block' : 'none';
  });

  /* Init */
  (function init(){
    try{ if('Notification' in window && Notification.permission==='default'){ Notification.requestPermission().catch(()=>{}); } }catch(e){}
    loadAll(); computeTotal(); draw(); updateShare();
    renderTasks();
    // Ensure pre-start layout (duration next to task; % hidden)
    showPreRow();
    document.body.dataset.tipsCollapsed='1';
  })();
})();
</script>
</body>
</html>
